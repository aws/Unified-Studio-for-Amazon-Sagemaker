# GitHub Workflows for SMUS CI/CD - Testing and Debugging Log

## Overview
Setting up and testing GitHub Actions workflows for SMUS CI/CD pipeline with multi-environment deployment (dev → test → prod).

## Infrastructure Setup

### Test Account (019900059033)
- Region: us-east-1
- Domain: dzd-bldfaa58kwf1ev (Default_11172025_Domain)
- Project: test-marketing (bbv3w6k2vk0753)
- GitHub Role: arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests
- Tagged domain with: purpose=smus-cicd-testing

### Dev Account (198737698272)
- Region: us-east-1
- Domain: (dev domain with purpose=smus-cicd-testing tag)
- Project: dev-marketing
- GitHub Role: arn:aws:iam::198737698272:role/GitHubActionsRole-SMUS-CLI-Tests

## Workflow Structure

### Reusable Workflow
File: `.github/workflows/smus-multi-env-reusable.yml`

Jobs:
1. **bundle** (dev-aws-account environment)
   - Validates dev target with `describe --connect`
   - Bundles from dev using `smus-cli bundle --target dev`
   - Uploads bundle artifact

2. **validate** (test-aws-account environment)
   - Validates all targets with `describe --connect`
   - Runs without environment context (uses branch-based trust policy)

3. **deploy-test** (test-aws-account environment)
   - Downloads bundle artifact
   - Validates test target with `describe --connect --targets test`
   - Deploys to test using `smus-cli deploy --targets test`

4. **test** (test-aws-account environment)
   - Runs tests using `smus-cli test --targets test`

5. **deploy-prod** (prod-aws-account environment)
   - Requires manual approval
   - Validates prod target with `describe --connect --targets prod`
   - Deploys to prod using `smus-cli deploy --targets prod`

### Application Workflows
Created 5 workflows for analytic examples:
- analytic-data-notebooks.yml (skip_bundle: true - PERMANENT, deploys directly from branch)
- analytic-dashboard-glue-quicksight.yml
- analytic-genai.yml (skip_bundle: true - PERMANENT, deploys directly from branch)
- analytic-ml-deployment.yml
- analytic-ml-training.yml

All trigger on push to test/main branches with path filters.

**Bundle Policy:**
- data-notebooks and genai: `skip_bundle: true` is PERMANENT
  - These workflows only contain storage files and serverless workflows
  - No MWAA workflows that need bundling from dev environment
  - Deploy directly from branch code to target environments
- Other workflows: Use bundle step to package from dev environment

## Testing Process

### Iteration 1: Initial Setup
**Issue**: Workflow installation failing
**Error**: Wrong directory, old pip version
**Fix**: 
- Changed to `experimental/SMUS-CICD-pipeline-cli`
- Added `python -m pip install --upgrade pip`
- Used `pip install -e ".[dev]"`

### Iteration 2: AWS Credentials
**Issue**: GitHub Actions OIDC authentication failing
**Error**: "Not authorized to perform sts:AssumeRoleWithWebIdentity"
**Fix**: Updated IAM role trust policy to include both environment and branch-based subjects:
```json
"StringLike": {
  "token.actions.githubusercontent.com:sub": [
    "repo:aws/Unified-Studio-for-Amazon-Sagemaker:environment:test-aws-account",
    "repo:aws/Unified-Studio-for-Amazon-Sagemaker:environment:dev-aws-account",
    "repo:aws/Unified-Studio-for-Amazon-Sagemaker:environment:prod-aws-account",
    "repo:aws/Unified-Studio-for-Amazon-Sagemaker:ref:refs/heads/test",
    "repo:aws/Unified-Studio-for-Amazon-Sagemaker:ref:refs/heads/main"
  ]
}
```

### Iteration 3: Domain Discovery
**Issue**: SMUS CLI couldn't find domain
**Error**: "No domain found matching criteria"
**Fix**: 
- Tagged DataZone domain with `purpose=smus-cicd-testing`
- Added `DOMAIN_REGION` and `DEV_DOMAIN_REGION` environment variables to all SMUS CLI steps

### Iteration 4: Project Permissions
**Issue**: ListConnections permission denied
**Error**: "User is not permitted to perform operation: ListConnections"
**Root Cause**: GitHub Actions role not a member of DataZone project
**Fix**: Added role as PROJECT_OWNER using groupIdentifier:
```bash
aws datazone create-project-membership \
  --domain-identifier dzd-bldfaa58kwf1ev \
  --project-identifier bbv3w6k2vk0753 \
  --designation PROJECT_OWNER \
  --member '{"groupIdentifier":"arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests"}'
```

### Iteration 5: CLI Parameter Corrections
**Issue**: Bundle command failing with "No such option: --targets"
**Error**: CLI uses different parameter names than documented
**Fix**: Verified all commands with `--help`:
- `bundle` uses `--target` (singular)
- `deploy` uses `--targets` (plural)
- `test` uses `--targets` (plural)
- `describe` uses `--targets` (plural)

### Iteration 6: Environment Configuration
**Issue**: Jobs not getting proper AWS regions from environments
**Fix**: 
- Added `environment:` to bundle and validate jobs
- bundle: `dev-aws-account`
- validate: `test-aws-account`
- deploy-test: `test-aws-account`
- test: `test-aws-account`
- deploy-prod: `prod-aws-account`

### Iteration 7: Workflow Split and Region Configuration
**Enhancement**: Split into two reusable workflows for cleaner execution
**Changes**:
- Created `smus-bundle-deploy.yml` for workflows needing bundling from dev
- Created `smus-direct-deploy.yml` for workflows deploying directly from branch
- Removed `skip_bundle` parameter - workflows choose appropriate pattern
- Changed all region references from `inputs.aws_region` to `vars.aws_region`
- Updated manifests to use separate env vars: `DEV_DOMAIN_REGION`, `TEST_DOMAIN_REGION`, `PROD_DOMAIN_REGION`
- Each job sets proper environment variables based on its environment context
- Renamed SMUS CLI steps for clarity: `smus-cli bundle from dev`, `smus-cli deploy to test`, etc.

**Workflow Assignments**:
- genai, data-notebooks → `smus-direct-deploy.yml`
- ml-training, ml-deployment, dashboard → `smus-bundle-deploy.yml`

**Region Configuration**:
- Dev account (198737698272): us-east-2
- Test account (019900059033): us-east-1
- Each job gets region from GitHub environment variable `vars.aws_region`
- Manifests use `${DEV_DOMAIN_REGION:us-east-2}` and `${TEST_DOMAIN_REGION:us-east-1}`

### Iteration 8: GitHub Environment Variables
**Issue**: Workflows failed with "aws-region required"
**Fix**: 
- Changed from `vars.aws_region` to `vars.DOMAIN_REGION` (already set in GitHub environments)
- Validate job now only validates test target with `--targets test`, not all targets
- Removed need for DEV_DOMAIN_REGION in validate job since it only checks test target
- Each job gets region from its environment's `vars.DOMAIN_REGION`

### Iteration 9: Hardcode Role ARNs
**Issue**: Deploy-test failed with "Could not load credentials"
**Fix**: 
- Replaced `secrets.AWS_ROLE_ARN_TEST` with hardcoded test account role ARN
- Added TODO comments to migrate to secrets later
- All jobs now use hardcoded role ARNs: dev (198737698272), test (019900059033)

### Iteration 10: IAM Permissions for Project Initialization
**Issue**: Deploy failed with "not authorized to perform: iam:TagRole"
**Root Cause**: SMUS CLI creates project execution role (smus-test-marketing-role) during initialization
**Fix**: 
- Added IAM permissions to CloudFormation template: iam:TagRole, iam:PutRolePolicy, iam:UpdateAssumeRolePolicy
- Updated stack smus-cli-github-integration in test account
- Role now has permissions to create and configure IAM roles for projects

## Key Learnings

### IAM Trust Policy Requirements
- Must include both environment-based and branch-based subjects
- Environment-based for jobs with `environment:` context
- Branch-based for jobs without environment (like validate)

### DataZone Project Membership
- IAM roles must be added as PROJECT_OWNER using `groupIdentifier`
- Cannot use `userIdentifier` for IAM roles
- Required for ListConnections and other DataZone operations

### SMUS CLI Parameters
- Always verify with `--help` output, not just documentation
- Parameter names vary by command (singular vs plural)
- Environment variables: `DOMAIN_REGION` and `DEV_DOMAIN_REGION` required

### Workflow Design
- Validate targets before operations with `describe --connect`
- Use proper environments for each job to get correct AWS regions
- Skip bundling for workflows that only copy files (data-notebooks)
- Hardcode role ARNs temporarily, migrate to secrets later

## Current Status
✅ Validate job passing
✅ All CLI commands verified
✅ Environment configuration complete
✅ Target validation added for all stages
✅ Split into bundle-deploy and direct-deploy workflows
✅ Region configuration using GitHub environment variables
⏳ Testing genai workflow with direct-deploy pattern

## Testing Commands

### Trigger Workflow
```bash
# Make change to manifest
echo "" >> experimental/SMUS-CICD-pipeline-cli/examples/analytic-workflow/data-notebooks/manifest.yaml
git add .
git commit -m "Test workflow"
git push origin test
```

### Monitor Workflow
```bash
# Watch latest run
gh run watch --repo aws/Unified-Studio-for-Amazon-Sagemaker \
  $(gh run list --repo aws/Unified-Studio-for-Amazon-Sagemaker --branch test --limit 1 --json databaseId --jq '.[0].databaseId')

# Get logs for failed job
gh api repos/aws/Unified-Studio-for-Amazon-Sagemaker/actions/jobs/{JOB_ID}/logs > /tmp/logs.txt
grep -i "error\|fail" /tmp/logs.txt
```

### Verify Setup
```bash
# Check domain tag
aws datazone list-domains --region us-east-1

# Check project membership
aws datazone list-project-memberships \
  --domain-identifier dzd-bldfaa58kwf1ev \
  --project-identifier bbv3w6k2vk0753 \
  --region us-east-1

# Check role trust policy
aws iam get-role --role-name GitHubActionsRole-SMUS-CLI-Tests
```

## Next Steps
1. Commit current changes
2. Trigger workflow with manifest change
3. Monitor for bundle job success
4. Verify deploy-test job
5. Add prod account setup if needed
6. Migrate hardcoded role ARNs to GitHub secrets
