pipelineName: IntegrationTestMultiTarget

# What to include in deployment bundles
bundle:
  bundlesDirectory: /tmp/bundles
  workflow:
    - connectionName: default.s3_shared
      append: true
      include: ['workflows']
      exclude: ['.ipynb_checkpoints/', '__pycache__/', '*.pyc']
  storage:
    - connectionName: default.s3_shared
      append: false
      include: ['src']
      exclude: ['.ipynb_checkpoints/', '__pycache__/', '*.pyc']

# Target environments (dev, test, prod)
targets:
  dev: 
    stage: DEV
    default: true
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: dev-marketing
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'

  test: 
    stage: TEST
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: integration-test-test
    tests:
      folder: tests/integration/multi_target_pipeline/pipeline_tests/
    initialization:
      project: 
        create: true  # Enable auto-create for integration tests
        profileName: 'All capabilities'
        owners: [Eng1, arn:aws:iam::058264284947:role/GitHubActionsRole-SMUS-CLI-Tests, Admin]
        contributors: []                     
      environments: 
        - EnvironmentConfigurationName: 'OnDemand Workflows' 
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'   

  prod:
    stage: PROD
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: integration-test-prod
    initialization:
      project: 
        create: true
        profileName: 'All capabilities'
        owners: [Eng1, arn:aws:iam::058264284947:role/GitHubActionsRole-SMUS-CLI-Tests]
        contributors: []                     
      environments: 
        - EnvironmentConfigurationName: 'OnDemand Workflows'         
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'

# Workflows to trigger after deployment
workflows:
  - workflowName: test_dag
    connectionName: project.workflow_mwaa
    logging: console
    engine: MWAA
  - workflowName: test_dag_not_mentioned
    connectionName: project.workflow_mwaa
    logging: console
    engine: MWAA
  - workflowName: runGettingStartedNotebook
    connectionName: project.workflow_mwaa
    logging: console
    engine: MWAA
