pipelineName: IntegrationTestMultiTargetAirless

# What to include in deployment bundles
bundle:
  bundlesDirectory: /tmp/bundles
  workflow:
    - connectionName: default.s3_shared
      append: true
      include: ['workflows']
      exclude: ['.ipynb_checkpoints/', '__pycache__/', '*.pyc']
      airflow-serverless: true
  storage:
    - connectionName: default.s3_shared
      append: false
      include: ['src']
      exclude: ['.ipynb_checkpoints/', '__pycache__/', '*.pyc']
  # catalog:
  #   # connectionName: default.domain 
  #   assets:
  #   - selector: 
  #       # assetId: xxxx
  #       search: 
  #         assetType: GlueTable
  #         identifier: covid19_db.countries_aggregated
  #     permission: READ 
  #     requestReason: Required access for pipeline IntegrationTestMultiTarget
  #   - selector:
  #       search:
  #         assetType: GlueTable
  #         identifier: covid19_db.worldwide_aggregate
  #     permission: READ
  #     requestReason: Second table access for multi-asset testing


# Target environments (dev, test, prod)
targets:
  dev: 
    stage: DEV
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: dev-marketing
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'
    environment_variables:
      S3_PREFIX: dev

  test: 
    stage: TEST
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: integration-airless-test
    tests:
      folder: tests/integration/multi_target_pipeline/pipeline_tests/
    initialization:
      project: 
        create: true  # Enable auto-create for integration tests
        profileName: 'All capabilities'
        owners: [Eng1, arn:aws:iam::058264284947:role/GitHubActionsRole-SMUS-CLI-Tests, Admin]
        contributors: []
        userParameters: 
          - EnvironmentConfigurationName: 'Lakehouse Database'
            parameters:
              - name: glueDbName
                value: multi_target_airless_test_db                     
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'   
    environment_variables:
      S3_PREFIX: test

  prod:
    stage: PROD
    domain:
      name: cicd-test-domain
      region: ${DEV_DOMAIN_REGION:us-east-2}
    project: 
      name: integration-airless-test
    initialization:
      project: 
        create: true
        profileName: 'All capabilities'
        owners: [Eng1, arn:aws:iam::058264284947:role/GitHubActionsRole-SMUS-CLI-Tests]
        contributors: []
        userParameters: 
          - EnvironmentConfigurationName: 'Lakehouse Database'
            parameters:
              - name: glueDbName
                value: multi_target_airless_prod_db                           
    bundle_target_configuration:
      storage:
        connectionName: default.s3_shared
        directory: 'src'
      workflows:
        connectionName: default.s3_shared
        directory: 'workflows'
    environment_variables:
      S3_PREFIX: prod


# Workflows to trigger after deployment
workflows:
  - workflowName: test_dag
    # connectionName: project.workflow_mwaa
    logging: console
    engine: airflow-serverless
