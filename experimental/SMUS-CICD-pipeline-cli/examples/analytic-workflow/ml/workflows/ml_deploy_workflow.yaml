ml_deploy_workflow:
  dag_id: 'sagemaker_deploy_pipeline'
  tasks:
    champion_model_retrieval:
      operator: airflow.providers.amazon.aws.operators.glue.GlueJobOperator
      job_name: 'champion-model-retrieval-{{ ds_nodash }}'
      script_location: 's3://{{ var.value.s3_bucket }}/scripts/get_champion_model.py'
      s3_bucket: '{{ var.value.s3_bucket }}'
      iam_role_name: 'OverdriveExecutionRole'
      script_args:
        '--MODEL_NAME': 'realistic-classifier-v1'
        '--MLFLOW_TRACKING_URI': '{{ var.value.mlflow_tracking_uri }}'
        '--STAGE': '{{ var.value.stage }}'

    model_registration:
      dependencies:
        - champion_model_retrieval
      operator: airflow.providers.amazon.aws.operators.sagemaker.SageMakerModelOperator
      config:
        ModelName: 'realistic-classifier-{{ var.value.stage }}-{{ ds_nodash }}'
        PrimaryContainer:
          Image: '246618743249.dkr.ecr.us-west-2.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3'
          ModelDataUrl: '{{ ti.xcom_pull(task_ids="champion_model_retrieval")["champion_model_s3_path"] }}'
        ExecutionRoleArn: 'arn:aws:iam::{{ var.value.account_id }}:role/SageMakerExecutionRole'

    endpoint_deployment:
      dependencies:
        - model_registration
      operator: airflow.providers.amazon.aws.operators.sagemaker.SageMakerEndpointOperator
      config:
        EndpointName: 'realistic-classifier-{{ var.value.stage }}-{{ ds_nodash }}'
        EndpointConfigName: 'realistic-classifier-config-{{ var.value.stage }}-{{ ds_nodash }}'
        ModelName: 'realistic-classifier-{{ var.value.stage }}-{{ ds_nodash }}'
        InstanceType: '{{ var.value.endpoint_instance_type | default("ml.t2.medium") }}'
        InitialInstanceCount: 1
      wait_for_completion: true

    endpoint_testing:
      dependencies:
        - endpoint_deployment
      operator: airflow.providers.amazon.aws.operators.sagemaker.SageMakerTransformOperator
      config:
        TransformJobName: '{{ var.value.stage }}-endpoint-test-{{ ds_nodash }}'
        ModelName: 'realistic-classifier-{{ var.value.stage }}-{{ ds_nodash }}'
        TransformInput:
          DataSource:
            S3DataSource:
              S3DataType: 'S3Prefix'
              S3Uri: 's3://{{ var.value.s3_bucket }}/test-data/'
          ContentType: 'text/csv'
        TransformOutput:
          S3OutputPath: 's3://{{ var.value.s3_bucket }}/{{ var.value.stage }}-test-results/'
        TransformResources:
          InstanceType: 'ml.m5.large'
          InstanceCount: 1
      wait_for_completion: true
