name: SMUS Direct Branch Deployment (Reusable)

# This is a REUSABLE workflow provided by DevOps
# It can be called from any repository's workflow
# See: https://docs.github.com/en/actions/using-workflows/reusing-workflows

on:
  workflow_call:
    inputs:
      manifest_path:
        description: 'Path to application manifest file'
        required: false
        type: string
        default: 'manifest.yaml'
      
      smus_cli_path:
        description: 'Path to SMUS CLI installation (relative to repo root)'
        required: false
        type: string
        default: 'experimental/SMUS-CICD-pipeline-cli'
      
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      
      aws_region:
        description: 'AWS region for authentication'
        required: false
        type: string
        default: 'us-east-1'
      
      test_branch:
        description: 'Branch name for test deployments'
        required: false
        type: string
        default: 'test'
      
      prod_branch:
        description: 'Branch name for production deployments'
        required: false
        type: string
        default: 'main'
      
      test_environment:
        description: 'GitHub environment name for test'
        required: false
        type: string
        default: 'aws-test'
      
      prod_environment:
        description: 'GitHub environment name for production'
        required: false
        type: string
        default: 'aws-prod'
      
      stage:
        description: 'Stage to deploy (for manual dispatch)'
        required: false
        type: string
        default: ''
    
    secrets:
      AWS_ROLE_ARN_TEST:
        description: 'AWS IAM role ARN for test deployments'
        required: true
      
      AWS_ROLE_ARN_PROD:
        description: 'AWS IAM role ARN for production deployments'
        required: true
      
      TEST_DOMAIN_REGION:
        description: 'AWS region for test domain'
        required: false
      
      PROD_DOMAIN_REGION:
        description: 'AWS region for production domain'
        required: false

permissions:
  id-token: write
  contents: write  # Required for automatic promotion (merge)
  pull-requests: write

jobs:
  # ============================================================================
  # VALIDATE - Check manifest and configuration
  # ============================================================================
  validate:
    name: "Validate Manifest"
    runs-on: ubuntu-latest
    outputs:
      manifest-path: ${{ steps.setup.outputs.manifest-path }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup manifest path
        id: setup
        run: |
          MANIFEST_PATH="${{ inputs.manifest_path }}"
          echo "manifest-path=$MANIFEST_PATH" >> $GITHUB_OUTPUT
          echo "Using manifest: $MANIFEST_PATH"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install SMUS CLI
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        working-directory: ${{ inputs.smus_cli_path }}
      
      - name: Validate manifest structure
        run: |
          echo "ðŸ“‹ Validating manifest structure..."
          smus-cli describe --manifest ${{ steps.setup.outputs.manifest-path }}
          echo "âœ… Manifest structure is valid"
        env:
          SMUS_LOG_LEVEL: WARNING

  # ============================================================================
  # TEST STAGE - Deploy to test environment
  # ============================================================================
  deploy-test:
    name: "Deploy to Test"
    runs-on: ubuntu-latest
    needs: [validate]
    if: |
      (github.event_name == 'push' && github.ref == format('refs/heads/{0}', inputs.test_branch)) ||
      (github.event_name == 'workflow_dispatch' && inputs.stage == 'test')
    environment: ${{ inputs.test_environment }}
    outputs:
      tests-passed: ${{ steps.run-tests.outcome == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TEST }}
          role-session-name: smus-deploy-test-${{ github.run_id }}
          role-duration-seconds: 3600
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install SMUS CLI
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        working-directory: ${{ inputs.smus_cli_path }}
      
      - name: Validate connections
        run: |
          echo "ðŸ” Validating AWS connections..."
          smus-cli describe \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            --connect
          echo "âœ… Connections validated"
        env:
          TEST_DOMAIN_REGION: ${{ secrets.TEST_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Deploy to test
        run: |
          echo "ðŸš€ Deploying to test environment..."
          smus-cli deploy \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            test
          echo "âœ… Deployed to test"
        env:
          TEST_DOMAIN_REGION: ${{ secrets.TEST_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Run tests
        id: run-tests
        run: |
          echo "ðŸ§ª Running tests in test..."
          smus-cli test \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            test
          echo "âœ… Tests passed"
        env:
          TEST_DOMAIN_REGION: ${{ secrets.TEST_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Create test results comment
        if: github.event_name == 'push'
        run: |
          echo "âœ… Test deployment successful and all tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready to promote to production via PR to ${{ inputs.prod_branch }} branch" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # PROMOTE & DEPLOY - Merge test to prod and deploy to production
  # Requires: Test deployment succeeded + Tests passed + Manual approval
  # ============================================================================
  promote-and-deploy-prod:
    name: "Promote & Deploy to Production"
    runs-on: ubuntu-latest
    needs: [validate, deploy-test]
    if: |
      github.event_name == 'push' &&
      github.ref == format('refs/heads/{0}', inputs.test_branch) &&
      needs.deploy-test.result == 'success' &&
      needs.deploy-test.outputs.tests-passed == 'true'
    environment: 
      name: ${{ inputs.prod_environment }}
      url: https://console.aws.amazon.com/
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Merge test to prod branch
        run: |
          echo "ðŸ”€ Merging ${{ inputs.test_branch }} to ${{ inputs.prod_branch }}..."
          git checkout ${{ inputs.prod_branch }}
          git pull origin ${{ inputs.prod_branch }}
          git merge origin/${{ inputs.test_branch }} --no-ff -m "chore: promote from ${{ inputs.test_branch }} to ${{ inputs.prod_branch }}"
          git push origin ${{ inputs.prod_branch }}
          echo "âœ… Merged successfully"
      
      - name: Checkout prod branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.prod_branch }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          role-session-name: smus-deploy-prod-${{ github.run_id }}
          role-duration-seconds: 3600
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install SMUS CLI
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        working-directory: ${{ inputs.smus_cli_path }}
      
      - name: Validate connections
        run: |
          echo "ðŸ” Validating AWS connections..."
          smus-cli describe \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            --connect
          echo "âœ… Connections validated"
        env:
          PROD_DOMAIN_REGION: ${{ secrets.PROD_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production environment..."
          smus-cli deploy \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            prod
          echo "âœ… Deployed to production"
        env:
          PROD_DOMAIN_REGION: ${{ secrets.PROD_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests in production..."
          smus-cli test \
            --manifest ${{ needs.validate.outputs.manifest-path }} \
            prod
          echo "âœ… Smoke tests passed"
        env:
          PROD_DOMAIN_REGION: ${{ secrets.PROD_DOMAIN_REGION }}
          SMUS_LOG_LEVEL: WARNING
      
      - name: Production deployment summary
        run: |
          echo "ðŸŽ‰ Production deployment completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted from:** \`${{ inputs.test_branch }}\` branch" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:** \`${{ inputs.prod_branch }}\` branch" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** Reviewer (via GitHub environment protection)" >> $GITHUB_STEP_SUMMARY
      
  # ============================================================================
  # SUMMARY - Report deployment status
  # ============================================================================
  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [validate, deploy-test, promote-and-deploy-prod]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manifest:** \`${{ needs.validate.outputs.manifest-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Branch | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test | \`${{ inputs.test_branch }}\` | ${{ needs.deploy-test.result == 'success' && 'âœ… Success' || needs.deploy-test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | \`${{ inputs.prod_branch }}\` | ${{ needs.promote-and-deploy-prod.result == 'success' && 'âœ… Success' || needs.promote-and-deploy-prod.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Branch Strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **feature/*** â†’ Dev stage (manual deployment by developers)" >> $GITHUB_STEP_SUMMARY
          echo "- **${{ inputs.test_branch }}** â†’ Test stage (automated deployment)" >> $GITHUB_STEP_SUMMARY
          echo "- **${{ inputs.prod_branch }}** â†’ Prod stage (automated deployment with approval)" >> $GITHUB_STEP_SUMMARY
