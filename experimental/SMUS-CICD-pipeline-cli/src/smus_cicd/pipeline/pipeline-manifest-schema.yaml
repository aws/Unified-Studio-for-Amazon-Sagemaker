$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://smus-cicd.example.com/schema/pipeline-manifest.yaml"
title: "SMUS CI/CD Pipeline Manifest"
description: "Schema for SageMaker Unified Studio CI/CD pipeline configuration"
type: object
required: 
  - pipelineName
  - domain
  - targets
properties:
  pipelineName:
    type: string
    description: "Unique name for the CI/CD pipeline"
    pattern: "^[A-Za-z][A-Za-z0-9_-]*$"
    minLength: 1
    maxLength: 64
  domain:
    type: object
    description: "DataZone domain configuration"
    required: 
      - name
      - region
    properties:
      name:
        type: string
        description: "DataZone domain name"
        minLength: 1
        maxLength: 64
      region:
        type: string
        description: "AWS region for the domain"
        pattern: "^[a-z0-9-]+$"
        examples: 
          - "us-east-1"
          - "us-west-2"
          - "eu-west-1"
    additionalProperties: false
  bundle:
    type: object
    description: "Configuration for creating deployment bundles"
    properties:
      bundlesDirectory:
        type: string
        description: "Directory or S3 location where bundles will be created/stored"
        examples: 
          - "./bundles"
          - "~/bundles"
          - "./tests/integration/bundles"
          - "s3://my-bucket/bundles"
          - "s3://sagemaker-unified-studio-<aws-account-id>-us-east-1-domain/bundles"
      workflow:
        type: array
        description: "Workflow bundle configuration"
        items:
          $ref: "#/definitions/bundleConnection"
      storage:
        type: array
        description: "Storage bundle configuration"
        items:
          $ref: "#/definitions/bundleConnection"
      git:
        type: object
        description: "Git repository to include in bundle"
        required: 
          - repository
          - url
          - targetDir
        properties:
          repository:
            type: string
            description: "Repository name"
          url:
            type: string
            format: uri
            description: "Git repository URL"
          targetDir:
            type: string
            description: "Target directory for git content"
        additionalProperties: false
    additionalProperties: false
  workflows:
    type: array
    description: "Workflows to trigger after deployment"
    items:
      type: object
      required: 
        - workflowName
        - connectionName
      properties:
        workflowName:
          type: string
          description: "Name of the workflow to trigger"
        connectionName:
          type: string
          description: "Connection to use for workflow execution"
          examples: 
            - "project.workflow_mwaa"
        engine:
          type: string
          description: "Workflow engine type"
          enum: 
            - "MWAA"
          default: "MWAA"
        parameters:
          type: object
          description: "Parameters to pass to the workflow"
          additionalProperties:
            type: 
              - string
              - number
              - boolean
        logging:
          type: string
          description: "Logging configuration"
          enum: 
            - "console"
            - "file"
            - "none"
          default: "console"
      additionalProperties: false
  targets:
    type: object
    description: "Target environments for deployment"
    minProperties: 1
    patternProperties:
      "^[a-zA-Z][a-zA-Z0-9_-]*$":
        $ref: "#/definitions/target"
    additionalProperties: false
additionalProperties: false

definitions:
  bundleConnection:
    type: object
    required: 
      - connectionName
    properties:
      connectionName:
        type: string
        description: "DataZone connection name"
        examples: 
          - "default.s3_shared"
          - "project.s3_default_folder"
      append:
        type: boolean
        description: "Whether to append to existing files or replace"
        default: false
      include:
        type: array
        description: "Patterns for files/directories to include"
        items:
          type: string
        examples: 
          - ["workflows/", "src/"]
      exclude:
        type: array
        description: "Patterns for files/directories to exclude"
        items:
          type: string
        examples: 
          - [".ipynb_checkpoints/", "__pycache__/", "*.pyc"]
    additionalProperties: false
  target:
    type: object
    required: 
      - project
      - stage
    properties:
      stage:
        type: string
        description: "Deployment stage name"
        minLength: 1
        examples: 
          - "DEV"
          - "TEST"
          - "PROD"
          - "dev"
          - "test"
          - "prod"
      default:
        type: boolean
        description: "Whether this is the default target"
        default: false
      project:
        type: object
        description: "DataZone project configuration"
        required: 
          - name
        properties:
          name:
            type: string
            description: "DataZone project name"
            minLength: 1
            maxLength: 64
          create:
            type: boolean
            description: "Whether the CLI should manage this target (create/update infrastructure)"
            default: false
          profile_name:
            type: string
            description: "Project profile name"
            examples: 
              - "All capabilities"
          owners:
            type: array
            description: "List of project owners"
            items:
              type: string
            default: []
          contributors:
            type: array
            description: "List of project contributors"
            items:
              type: string
            default: []
        additionalProperties: false
      initialization:
        type: object
        description: "Target initialization configuration"
        properties:
          project:
            type: object
            description: "Project creation configuration"
            properties:
              create:
                type: boolean
                description: "Whether to create the project if it doesn't exist"
                default: false
              profileName:
                type: string
                description: "Project profile name"
                examples: 
                  - "All capabilities"
              owners:
                type: array
                description: "List of project owners"
                items:
                  type: string
                examples: 
                  - ["Eng1", "Admin"]
              contributors:
                type: array
                description: "List of project contributors"
                items:
                  type: string
                default: []
              userParameters:
                type: array
                description: "User parameters to override during project creation, organized by environment configuration"
                items:
                  type: object
                  properties:
                    EnvironmentConfigurationName:
                      type: string
                      description: "Name of the environment configuration"
                    parameters:
                      type: array
                      description: "Parameters to override for this environment configuration"
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                            description: "Parameter name"
                          value:
                            type: string
                            description: "Parameter value"
                        required: ["name", "value"]
                        additionalProperties: false
                  required: ["EnvironmentConfigurationName", "parameters"]
                  additionalProperties: false
                default: []
            additionalProperties: false
          environments:
            type: array
            description: "Environment configurations to create"
            items:
              type: object
              required: 
                - EnvironmentConfigurationName
              properties:
                EnvironmentConfigurationName:
                  type: string
                  description: "Name of the environment configuration"
                  examples: 
                    - "OnDemand Workflows"
              additionalProperties: false
        additionalProperties: false
      bundle_target_configuration:
        type: object
        description: "Target-specific bundle configuration"
        properties:
          storage:
            type: object
            description: "Storage configuration for this target"
            required: 
              - connectionName
              - directory
            properties:
              connectionName:
                type: string
                description: "DataZone connection name"
              directory:
                type: string
                description: "Target directory"
            additionalProperties: false
          workflows:
            type: object
            description: "Workflow configuration for this target"
            required: 
              - connectionName
              - directory
            properties:
              connectionName:
                type: string
                description: "DataZone connection name"
              directory:
                type: string
                description: "Target directory"
            additionalProperties: false
          git:
            type: object
            description: "Git configuration for this target"
            required: 
              - connectionName
              - directory
            properties:
              connectionName:
                type: string
                description: "DataZone connection name"
              directory:
                type: string
                description: "Target directory"
            additionalProperties: false
        additionalProperties: false
      workflows:
        type: array
        description: "Target-specific workflow configurations"
        items:
          type: object
          required: 
            - workflowName
          properties:
            workflowName:
              type: string
              description: "Name of the workflow"
            parameters:
              type: object
              description: "Target-specific workflow parameters"
              additionalProperties:
                type: 
                  - string
                  - number
                  - boolean
          additionalProperties: false
      tests:
        type: object
        description: "Test configuration for this target"
        properties:
          folder:
            type: string
            description: "Relative path to folder containing Python test files"
            examples:
              - "tests/"
              - "integration_tests/"
        required: ["folder"]
        additionalProperties: false
    additionalProperties: false
