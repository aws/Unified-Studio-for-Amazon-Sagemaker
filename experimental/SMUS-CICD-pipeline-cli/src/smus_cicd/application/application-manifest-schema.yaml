$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://smus-cicd.example.com/schema/application-manifest.yaml"
title: "SMUS CI/CD Application Manifest"
description: "Schema for SageMaker Unified Studio CI/CD application deployment configuration"
type: object
required: 
  - applicationName
  - stages
properties:
  applicationName:
    type: string
    description: "Unique name for the application (alphanumeric, hyphens, underscores only)"
    pattern: "^[A-Za-z0-9][A-Za-z0-9_-]*$"
    minLength: 1
    maxLength: 50
  
  content:
    type: object
    description: "Application content to deploy"
    properties:
      storage:
        type: array
        description: "Storage content configuration"
        items:
          $ref: "#/definitions/storageContent"
      git:
        type: array
        description: "Git repositories to include"
        items:
          type: object
          required: 
            - repository
            - url
          properties:
            repository:
              type: string
              description: "Repository name"
            url:
              type: string
              format: uri
              description: "Git repository URL"
          additionalProperties: false
      catalog:
        type: object
        description: "Catalog assets configuration for DataZone access"
        properties:
          connectionName:
            type: string
            description: "Connection name for catalog access"
            examples:
              - "default.domain"
          assets:
            type: array
            description: "List of catalog assets to request access to"
            items:
              type: object
              required:
                - selector
              properties:
                selector:
                  type: object
                  description: "Asset selector configuration"
                  properties:
                    assetId:
                      type: string
                      description: "Direct asset ID"
                    search:
                      type: object
                      description: "Search configuration for finding assets"
                      properties:
                        assetType:
                          type: string
                          description: "Type of asset to search for"
                          examples:
                            - "GlueTable"
                        identifier:
                          type: string
                          description: "Asset identifier (e.g., database.table)"
                          examples:
                            - "covid19_db.countries_aggregated"
                      additionalProperties: false
                  additionalProperties: false
                permission:
                  type: string
                  description: "Permission level requested"
                  enum:
                    - "READ"
                    - "WRITE"
                  default: "READ"
                requestReason:
                  type: string
                  description: "Reason for requesting access"
                  examples:
                    - "Required access for application deployment"
              additionalProperties: false
        additionalProperties: false
      quicksight:
        type: array
        description: "QuickSight assets to deploy (use name for lookup, not ID)"
        items:
          type: object
          required:
            - name
            - type
          properties:
            name:
              type: string
              description: "Dashboard/dataset name (used for lookup in QuickSight)"
            type:
              type: string
              description: "Asset type: dashboard, dataset, analysis, datasource"
              enum: [dashboard, dataset, analysis, datasource]
              default: dashboard
            assetBundle:
              type: string
              description: "Local asset bundle file path (e.g., quicksight/dashboard.qs). If not provided, exports from QuickSight by name"
            recursive:
              type: boolean
              description: "Export with all dependencies (datasets, datasources)"
              default: false
          additionalProperties: false
      workflows:
        type: array
        description: "Workflow definitions for the application"
        items:
          type: object
          required:
            - workflowName
            - connectionName
          properties:
            workflowName:
              type: string
              description: "Name of the workflow"
            connectionName:
              type: string
              description: "DataZone connection name for workflow execution"
              examples:
                - "default.workflow_serverless"
                - "default.workflow_mwaa"
            parameters:
              type: object
              description: "Workflow-specific parameters"
              additionalProperties: true
          additionalProperties: false
    additionalProperties: false
  
  bootstrap:
    type: object
    description: "Initialization configuration with actions to run during deployment"
    properties:
      actions:
        type: array
        description: "Ordered list of initialization actions"
        items:
          type: object
          required:
            - type
          properties:
            type:
              type: string
              description: "Type of initialization action"
              enum:
                - workflow
                - event
                - cloudformation
            
            # Workflow-specific fields
            workflowName:
              type: string
              description: "Name of the workflow (required for type: workflow)"
            connectionName:
              type: string
              description: "Connection name (for type: workflow with MWAA)"
            engine:
              type: string
              description: "Workflow engine (for type: workflow)"
              enum:
                - MWAA
                - airflow-serverless
              default: MWAA
            triggerPostDeployment:
              type: boolean
              description: "Trigger after deployment (for type: workflow)"
              default: false
            parameters:
              type: object
              description: "Parameters (for type: workflow)"
              additionalProperties:
                type:
                  - string
                  - number
                  - boolean
            logging:
              type: string
              description: "Logging config (for type: workflow)"
              enum:
                - console
                - file
                - none
              default: console
            
            # Event-specific fields
            eventSource:
              type: string
              description: "Event source identifier (required for type: event)"
            eventDetailType:
              type: string
              description: "Event detail type (required for type: event)"
            eventBusName:
              type: string
              description: "EventBridge event bus name or ARN (for type: event)"
              default: "default"
            detail:
              type: object
              description: "Event detail payload with variable support (for type: event)"
              additionalProperties: true
            resources:
              type: array
              description: "Resource ARNs related to the event (for type: event)"
              items:
                type: string
            
            # CloudFormation-specific fields
            stackName:
              type: string
              description: "CloudFormation stack name (for type: cloudformation)"
            templatePath:
              type: string
              description: "Path to CloudFormation template (for type: cloudformation)"
          
          additionalProperties: false
    additionalProperties: false
  
  tests:
    type: object
    description: "Integration tests to run with 'smus-cli test' command"
    properties:
      folder:
        type: string
        description: "Relative path to folder containing Python test files"
        examples:
          - "tests/"
          - "tests/integration/"
    required: ["folder"]
    additionalProperties: false
  
  monitoring:
    type: object
    description: "Monitoring configuration for application events"
    properties:
      eventbridge:
        type: object
        description: "EventBridge monitoring configuration"
        properties:
          enabled:
            type: boolean
            description: "Enable EventBridge monitoring"
            default: false
          eventBusName:
            type: string
            description: "EventBridge event bus name"
            default: "default"
          includeMetadata:
            type: boolean
            description: "Include metadata in events"
            default: true
        additionalProperties: false
    additionalProperties: false
  
  stages:
    type: object
    description: "Deployment stages (dev, test, prod)"
    minProperties: 1
    patternProperties:
      "^[a-zA-Z][a-zA-Z0-9_-]*$":
        $ref: "#/definitions/stage"
    additionalProperties: false

additionalProperties: false

definitions:
  storageContent:
    type: object
    required: 
      - name
    properties:
      name:
        type: string
        description: "Name identifier for this content (used as subdirectory)"
        examples:
          - "etl"
          - "workflows"
          - "notebooks"
      connectionName:
        type: string
        description: "DataZone connection name (optional - if not provided, uses local filesystem)"
        examples: 
          - "default.s3_shared"
          - "project.s3_default_folder"
      append:
        type: boolean
        description: "Whether to append to existing files or replace"
        default: false
      include:
        type: array
        description: "Patterns for files/directories to include"
        items:
          type: string
        examples: 
          - ["workflows/", "src/"]
      exclude:
        type: array
        description: "Patterns for files/directories to exclude"
        items:
          type: string
        examples: 
          - [".ipynb_checkpoints/", "__pycache__/", "*.pyc"]
    additionalProperties: false
  
  stage:
    type: object
    required: 
      - project
      - domain
      - stage
    properties:
      stage:
        type: string
        description: "Deployment stage name"
        minLength: 1
        examples: 
          - "DEV"
          - "TEST"
          - "PROD"
          - "dev"
          - "test"
          - "prod"
      branch:
        type: string
        description: "Optional git branch for this stage (for git-based deployments)"
        examples:
          - "release_test"
          - "release_prod"
      default:
        type: boolean
        description: "Whether this is the default stage"
        default: false
      domain:
        type: object
        description: "DataZone domain configuration"
        required: 
          - region
        properties:
          name:
            type: string
            description: "DataZone domain name"
            minLength: 1
            maxLength: 64
          tags:
            type: object
            description: "Tags to identify the domain (alternative to name)"
            additionalProperties:
              type: string
          region:
            type: string
            description: "AWS region for the domain. Supports environment variable substitution ${VAR_NAME:default_value}"
            pattern: "^(\\$\\{[A-Za-z_][A-Za-z0-9_]*:[a-z0-9-]+\\}|[a-z0-9-]+)$"
            examples: 
              - "us-east-1"
              - "us-west-2"
              - "${DEV_DOMAIN_REGION:us-east-1}"
        additionalProperties: false
      project:
        type: object
        description: "DataZone project configuration"
        required: 
          - name
        properties:
          name:
            type: string
            description: "DataZone project name"
            minLength: 1
            maxLength: 64
          create:
            type: boolean
            description: "Whether the CLI should manage this stage (create/update infrastructure)"
            default: false
          profile_name:
            type: string
            description: "Project profile name"
            examples: 
              - "All capabilities"
          owners:
            type: array
            description: "List of project owners"
            items:
              type: string
            default: []
          contributors:
            type: array
            description: "List of project contributors"
            items:
              type: string
            default: []
          role:
            type: object
            description: "IAM role configuration"
            properties:
              arn:
                type: string
              policies:
                type: array
                items:
                  type: string
            additionalProperties: false
          user_parameters:
            type: array
            items:
              type: object
              properties:
                environment_configuration_name:
                  type: string
                parameters:
                  type: array
                  items:
                    type: object
              additionalProperties: false
        additionalProperties: false
      bootstrap:
        type: object
        description: "Bootstrap actions to execute during deployment"
        properties:
          actions:
            type: array
            description: "List of bootstrap actions to execute sequentially"
            items:
              type: object
              required:
                - type
              properties:
                type:
                  type: string
                  description: "Action type in format 'service.action'"
              additionalProperties: true
            default: []
        additionalProperties: false
      deployment_configuration:
        type: object
        description: "Stage-specific deployment configuration"
        properties:
          storage:
            type: array
            description: "Storage deployment configurations"
            items:
              type: object
              required:
                - connectionName
                - name
              properties:
                name:
                  type: string
                  description: "Name identifier for this storage content"
                connectionName:
                  type: string
                  description: "DataZone connection name"
                targetDirectory:
                  type: string
                  description: "Target directory"
                compression:
                  type: string
                  enum: ['gz', 'tar.gz']
                  description: "Optional compression format"
              additionalProperties: false
          workflows:
            type: object
            description: "Workflow deployment configuration for this stage"
            required: 
              - connectionName
              - directory
            properties:
              connectionName:
                type: string
                description: "DataZone connection name"
              directory:
                type: string
                description: "Target directory"
            additionalProperties: false
          git:
            type: array
            description: "Git deployment configuration for this stage"
            items:
              type: object
              required: 
                - name
                - connectionName
                - targetDirectory
              properties:
                name:
                  type: string
                  description: "Git repository name"
                connectionName:
                  type: string
                  description: "DataZone connection name"
                targetDirectory:
                  type: string
                  description: "Target directory"
              additionalProperties: false
          catalog:
            type: object
            description: "Catalog configuration for this stage"
            properties:
              disable:
                type: boolean
                description: "Disable catalog asset processing for this stage"
          quicksight:
            type: object
            description: "QuickSight deployment configuration for this stage"
            properties:
              items:
                type: array
                description: "Per-dashboard permissions configuration"
                items:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      description: "Dashboard name (must match content.quicksight.name)"
                    owners:
                      type: array
                      description: "List of QuickSight user ARNs with owner permissions"
                      items:
                        type: string
                    viewers:
                      type: array
                      description: "List of QuickSight user ARNs with viewer permissions"
                      items:
                        type: string
                  additionalProperties: false
              overrideParameters:
                type: object
                description: "Parameters to override during dashboard import (AWS QuickSight OverrideParameters structure)"
                additionalProperties: true
            additionalProperties: false
        additionalProperties: false
      environment_variables:
        type: object
        description: "Environment variables for this stage"
        additionalProperties:
          type: string
    additionalProperties: false
