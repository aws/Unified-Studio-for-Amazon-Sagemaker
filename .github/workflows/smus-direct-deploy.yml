name: SMUS Direct Deploy (Reusable)

on:
  workflow_call:
    inputs:
      manifest_path:
        description: 'Path to manifest file'
        required: false
        type: string
        default: 'manifest.yaml'
      
      test_target:
        description: 'Test environment target name'
        required: false
        type: string
        default: 'test'
      
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-deploy-test-session
      
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: smus-cli deploy to test (direct from branch)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          echo "üöÄ Deploying directly from branch to test"
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli deploy \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}
      
      - name: Download workflow output notebooks
        if: always()
        continue-on-error: true
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          WORKFLOW_NAME=$(basename $(dirname ${{ inputs.manifest_path }}))
          FULL_WORKFLOW_NAME="IntegrationTest${WORKFLOW_NAME^}_test_marketing_*"
          echo "üì• Downloading outputs for workflow: $FULL_WORKFLOW_NAME"
          python3 tests/scripts/download_workflow_outputs_from_xcom.py \
            "$FULL_WORKFLOW_NAME" \
            --region ${{ vars.DOMAIN_REGION }} \
            --output-dir tests/test-outputs/notebooks || echo "‚ö†Ô∏è No outputs found"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: deploy-test
    if: ${{ !inputs.skip_tests }}
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-test-session
      
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: smus-cli test
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli test \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}
