name: SMUS Direct Deploy (Reusable)

on:
  workflow_call:
    inputs:
      manifest_path:
        description: 'Path to manifest file'
        required: false
        type: string
        default: 'manifest.yaml'
      
      test_target:
        description: 'Test environment target name'
        required: false
        type: string
        default: 'test'
      
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      # DEBUG: Verify notebook after checkout
      - name: "[DEBUG] Verify notebook after git checkout"
        run: |
          python3 experimental/SMUS-CICD-pipeline-cli/.github/verify_notebook.py \
            experimental/SMUS-CICD-pipeline-cli/examples/analytic-workflow/genai/workflows/bedrock_agent_notebook.ipynb \
            "After git checkout"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-deploy-test-session
      
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/datazone-internal-2018-05-10.json \
            --service-name datazone-internal
      
      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "âœ“ AWS Account ID: $ACCOUNT_ID"
      
      - name: smus-cli deploy to test (direct from branch)
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          MLFLOW_TRACKING_SERVER_NAME: smus-integration-mlflow-use1
          MLFLOW_ARTIFACT_LOCATION: s3://amazon-sagemaker-${{ steps.aws-account.outputs.account-id }}-${{ vars.DOMAIN_REGION }}-${{ vars.PROJECT_ID }}/shared/ml/mlflow-artifacts
          STS_REGION: ${{ vars.DOMAIN_REGION }}
          STS_ACCOUNT_ID: ${{ steps.aws-account.outputs.account-id }}
          AWS_ACCOUNT_ID: ${{ steps.aws-account.outputs.account-id }}
        run: |
          echo "ðŸš€ Deploying directly from branch to test"
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli deploy \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}
      
      # DEBUG: Verify notebook in S3 after deploy
      - name: "[DEBUG] Verify notebook in S3 after deploy"
        run: |
          aws s3 cp s3://amazon-sagemaker-${{ steps.aws-account.outputs.account-id }}-${{ vars.DOMAIN_REGION }}-${{ vars.PROJECT_ID }}/shared/genai/bundle/workflows/bedrock_agent_notebook.ipynb /tmp/s3_notebook.ipynb
          python3 experimental/SMUS-CICD-pipeline-cli/.github/verify_notebook.py \
            /tmp/s3_notebook.ipynb \
            "After S3 upload"
      
      - name: Download workflow output notebooks
        if: always()
        continue-on-error: true
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          
          # Extract workflow names from manifest
          python3 << 'EOF'
          import yaml
          import sys
          
          manifest_path = "../../${{ inputs.manifest_path }}"
          try:
              with open(manifest_path, 'r') as f:
                  manifest = yaml.safe_load(f)
              
              app_name = manifest.get('applicationName', '')
              workflows = manifest.get('content', {}).get('workflows', [])
              
              if not workflows:
                  print("No workflows found in manifest")
                  sys.exit(0)
              
              # Get project name from test target
              project_name = "${{ inputs.test_target }}-marketing"
              
              # Download outputs for each workflow
              for workflow in workflows:
                  workflow_name = workflow.get('workflowName', '')
                  if workflow_name:
                      full_name = f"{app_name}_{project_name}_{workflow_name}"
                      print(f"ðŸ“¥ Downloading outputs for workflow: {full_name}")
                      
                      import subprocess
                      result = subprocess.run([
                          'python3', 'tests/scripts/download_workflow_outputs_from_xcom.py',
                          full_name,
                          '--region', '${{ vars.DOMAIN_REGION }}',
                          '--output-dir', 'tests/test-outputs/notebooks'
                      ], capture_output=True, text=True)
                      
                      if result.stdout:
                          print(result.stdout)
                      if result.stderr:
                          print(result.stderr)
                      
                      if result.returncode == 0:
                          print(f"âœ… Downloaded outputs for {workflow_name}")
                      else:
                          print(f"âš ï¸ No outputs found for {workflow_name}")
          
          except Exception as e:
              print(f"âŒ Error downloading notebooks: {e}")
              sys.exit(0)  # Don't fail the workflow
          EOF

      - name: Upload workflow output notebooks
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-output-notebooks-${{ github.run_id }}
          path: experimental/SMUS-CICD-pipeline-cli/tests/test-outputs/notebooks/**
          if-no-files-found: ignore
          retention-days: 7

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: deploy-test
    if: ${{ !inputs.skip_tests }}
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::019900059033:role/GitHubActionsRole-SMUS-CLI-Tests
          aws-region: ${{ vars.DOMAIN_REGION }}
          role-session-name: smus-test-session
      
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/datazone-internal-2018-05-10.json \
            --service-name datazone-internal
      
      - name: Get AWS Account ID
        id: aws-account-test
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "âœ“ AWS Account ID: $ACCOUNT_ID"
      
      - name: smus-cli test
        env:
          DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          TEST_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          DEV_DOMAIN_REGION: ${{ vars.DOMAIN_REGION }}
          MLFLOW_TRACKING_SERVER_NAME: smus-integration-mlflow-use1
          MLFLOW_ARTIFACT_LOCATION: s3://amazon-sagemaker-${{ steps.aws-account-test.outputs.account-id }}-${{ vars.DOMAIN_REGION }}-${{ vars.PROJECT_ID }}/shared/ml/mlflow-artifacts
          STS_REGION: ${{ vars.DOMAIN_REGION }}
          STS_ACCOUNT_ID: ${{ steps.aws-account-test.outputs.account-id }}
          AWS_ACCOUNT_ID: ${{ steps.aws-account-test.outputs.account-id }}
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli test \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}
