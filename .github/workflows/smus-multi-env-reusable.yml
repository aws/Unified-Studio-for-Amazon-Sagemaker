name: SMUS Multi-Environment Deploy (Reusable)

on:
  workflow_call:
    inputs:
      manifest_path:
        description: 'Path to manifest file'
        required: false
        type: string
        default: 'manifest.yaml'
      
      test_target:
        description: 'Test environment target name'
        required: false
        type: string
        default: 'test'
      
      prod_target:
        description: 'Production environment target name'
        required: false
        type: string
        default: 'prod'
      
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      
      deploy_to_prod:
        description: 'Deploy to production after test'
        required: false
        type: boolean
        default: true
      
      skip_bundle:
        description: 'Skip bundle step'
        required: false
        type: boolean
        default: false
    
    # No secrets needed - use environment secrets instead

permissions:
  id-token: write
  contents: read

jobs:
  bundle:
    name: Bundle Application
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_bundle }}
    environment: dev-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: smus-bundle-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Bundle application
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli bundle \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets dev
      
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: experimental/SMUS-CICD-pipeline-cli/examples/**/bundles/*.zip
          if-no-files-found: error

  validate:
    name: Validate Manifest
    runs-on: ubuntu-latest
    needs: bundle
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Validate configuration
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli describe --manifest ../../${{ inputs.manifest_path }} --connect

  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: validate
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download bundle artifact
        if: ${{ !inputs.skip_bundle }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: experimental/SMUS-CICD-pipeline-cli/examples/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: smus-deploy-test-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Deploy to test
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli deploy \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: deploy-test
    if: ${{ !inputs.skip_tests }}
    environment: test-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: smus-test-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Run validation tests
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli test \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.test_target }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-test, test]
    if: ${{ inputs.deploy_to_prod && (success() || inputs.skip_tests) }}
    environment: prod-aws-account
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download bundle artifact
        if: ${{ !inputs.skip_bundle }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-bundle
          path: experimental/SMUS-CICD-pipeline-cli/examples/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install SMUS CLI
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: smus-deploy-prod-session
      
      # Temporary: Register mwaaserverless-internal model until service is GA
      - name: Register AWS CLI model patch
        run: |
          aws configure add-model \
            --service-model file://experimental/SMUS-CICD-pipeline-cli/src/smus_cicd/resources/mwaaserverless-2024-07-26.normal-edited-2.json \
            --service-name mwaaserverless-internal
      
      - name: Deploy to production
        run: |
          cd experimental/SMUS-CICD-pipeline-cli
          smus-cli deploy \
            --manifest ../../${{ inputs.manifest_path }} \
            --targets ${{ inputs.prod_target }}
