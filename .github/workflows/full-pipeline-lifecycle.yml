name: Full SMUS CICD Pipeline Lifecycle Demo

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'experimental/SMUS-CICD-pipeline-cli/**'
  workflow_dispatch:
    inputs:
      domain_name:
        description: 'SageMaker Unified Studio domain name'
        required: true
        default: 'cicd-test-domain'
      project_name:
        description: 'Development project name'
        required: true
        default: 'dev-marketing'
      pipeline_name:
        description: 'Pipeline name for the demo'
        required: true
        default: 'DemoMarketingPipeline'

permissions:
  id-token: write
  contents: read

jobs:
  # cleanup:
  #   name: "Step 1 - Cleanup Previous Resources"
  #   runs-on: ubuntu-latest
  #   environment: aws-env
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Configure AWS credentials
  #     uses: aws-actions/configure-aws-credentials@v4
  #     with:
  #       aws-region: us-east-1
  #       role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #       role-session-name: smus-pipeline-lifecycle-cleanup
  #       role-duration-seconds: 43200  # 12 hours for long-running operations
  #   
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.12'
  #   
  #   - name: Install dependencies
  #     run: |
  #       cd experimental/SMUS-CICD-pipeline-cli
  #       python -m pip install --upgrade pip --no-cache-dir
  #       pip install -e ".[dev]" --no-cache-dir
  #   
  #   - name: Cleanup previous test resources
  #     run: |
  #       cd experimental/SMUS-CICD-pipeline-cli/examples
  #       echo "🧹 Cleaning up previous test resources..."
  #       
  #       # Try to delete test target resources if they exist
  #       smus-cli delete \
  #         --pipeline "DemoMarketingPipeline.yaml" \
  #         --targets test \
  #         --force || echo "No test resources to clean up"
  #       
  #       echo "✅ Cleanup completed"
  #     continue-on-error: true

  setup:
    name: "Step 1 - Setup Domain and Project IDs"
    runs-on: ubuntu-latest
    environment: aws-env
    # needs: cleanup
    outputs:
      domain-id: ${{ steps.resolve.outputs.domain-id }}
      project-id: ${{ steps.resolve.outputs.project-id }}
      pipeline-file: ${{ steps.resolve.outputs.pipeline-file }}
      domain-name: ${{ steps.resolve.outputs.domain-name }}
      project-name: ${{ steps.resolve.outputs.project-name }}
      pipeline-name: ${{ steps.resolve.outputs.pipeline-name }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate environment variables
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
      run: |
        echo "Validating required environment variables..."
        echo "DEV_DOMAIN_REGION: ${DEV_DOMAIN_REGION:-NOT_SET}"
        if [ -z "$DEV_DOMAIN_REGION" ]; then
          echo "❌ ERROR: DEV_DOMAIN_REGION environment variable is not set in aws-env environment"
          echo "Please set DEV_DOMAIN_REGION in GitHub repository settings > Environments > aws-env"
          exit 1
        fi
        echo "✅ All required environment variables are set"
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-setup
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Resolve Domain and Project IDs
      id: resolve
      run: |
        # Set default values when inputs are not available (e.g., on pull_request)
        DOMAIN_NAME="${{ github.event.inputs.domain_name || 'cicd-test-domain' }}"
        PROJECT_NAME="${{ github.event.inputs.project_name || 'dev-marketing' }}"
        PIPELINE_NAME="${{ github.event.inputs.pipeline_name || 'DemoMarketingPipeline' }}"
        
        echo "🔍 Using domain: $DOMAIN_NAME"
        echo "🔍 Using project: $PROJECT_NAME"
        echo "🔍 Using pipeline: $PIPELINE_NAME"
        
        # Resolve domain ID
        DOMAIN_ID=$(aws datazone list-domains --query "items[?name=='$DOMAIN_NAME'].id" --output text)
        if [ -z "$DOMAIN_ID" ] || [ "$DOMAIN_ID" = "None" ]; then
          echo "❌ Domain '$DOMAIN_NAME' not found"
          exit 1
        fi
        
        # Resolve project ID
        PROJECT_ID=$(aws datazone list-projects --domain-identifier "$DOMAIN_ID" --query "items[?name=='$PROJECT_NAME'].id" --output text)
        if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "None" ]; then
          echo "❌ Project '$PROJECT_NAME' not found in domain"
          exit 1
        fi
        
        PIPELINE_FILE="${PIPELINE_NAME}.yaml"
        
        echo "✅ Domain ID: $DOMAIN_ID"
        echo "✅ Project ID: $PROJECT_ID"
        echo "✅ Using existing pipeline file: DemoMarketingPipeline.yaml"
        
        # Set outputs
        echo "domain-id=$DOMAIN_ID" >> $GITHUB_OUTPUT
        echo "project-id=$PROJECT_ID" >> $GITHUB_OUTPUT
        echo "pipeline-file=DemoMarketingPipeline.yaml" >> $GITHUB_OUTPUT
        echo "domain-name=$DOMAIN_NAME" >> $GITHUB_OUTPUT
        echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "pipeline-name=$PIPELINE_NAME" >> $GITHUB_OUTPUT

  validate-configuration:
    name: "Step 2 - Validate Pipeline Configuration"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-validate
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Validate pipeline configuration
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli describe \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --workflows --connections --connect --output TEXT
        
        echo "✅ Pipeline configuration validated"

  create-bundle:
    name: "Step 2 - Create Deployment Bundle"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup, validate-configuration]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-bundle
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Create deployment bundle
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli bundle \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets dev --output JSON
        
        echo "✅ Deployment bundle created for dev target"
    
    - name: Upload deployment bundle
      uses: actions/upload-artifact@v4
      with:
        name: deployment-bundle
        path: experimental/SMUS-CICD-pipeline-cli/examples/bundles/${{ needs.setup.outputs.pipeline-name }}.zip

  deploy-test:
    name: "Step 3 - Deploy to Test Environment"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup, create-bundle]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-deploy
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Download deployment bundle
      uses: actions/download-artifact@v4
      with:
        name: deployment-bundle
        path: experimental/SMUS-CICD-pipeline-cli/examples/bundles/
    
    - name: Deploy to test environment
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli deploy \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test
        
        echo "✅ Deployed to test environment"

  run-tests-test-target:
    name: "Step 4 - Run Tests (Test Target)"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup, deploy-test]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-test
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Run tests on Test target
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli test \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test
        
        echo "✅ Tests completed on Test target"

  monitor-pipeline-test-target:
    name: "Step 5 - Monitor Pipeline Status (Test Target)"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup, run-tests-test-target]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-monitor
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Monitor pipeline status for Test target
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli monitor \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test \
          --output TEXT
        
        echo "✅ Pipeline monitoring completed for Test target"

  execute-workflows-test-target:
    name: "Step 6 - Execute Workflow Commands (Test Target)"
    runs-on: ubuntu-latest
    environment: aws-env
    needs: [setup, monitor-pipeline-test-target]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-execute
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    
    - name: Trigger DAG on Test target
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test --workflow test_dag \
          --command "dags trigger test_dag"
        
        echo "✅ DAG triggered on Test target"
    
    - name: List DAG tasks on Test target
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test --workflow test_dag \
          --command "tasks list test_dag"
        
        echo "✅ DAG tasks listed on Test target"
    
    - name: Check task state on Test target
      env:
        DEV_DOMAIN_REGION: ${{ vars.DEV_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        EXECUTION_DATE=$(date -u +'manual__%Y-%m-%dT%H:%M:%S+00:00')
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets test --workflow test_dag \
          --command "tasks state test_dag hello_world $EXECUTION_DATE"
        
        echo "✅ Task state checked on Test target"

  deploy-prod:
    name: "Step 7 - Deploy to Production Environment"
    runs-on: ubuntu-latest
    environment: aws-env-amirbo-6778
    needs: [setup, execute-workflows-test-target]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-deploy-prod
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Download deployment bundle
      uses: actions/download-artifact@v4
      with:
        name: deployment-bundle
        path: experimental/SMUS-CICD-pipeline-cli/examples/bundles/
    
    - name: Deploy to production environment
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli deploy \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod
        
        echo "✅ Deployed to production environment"

  run-tests-prod-target:
    name: "Step 8 - Run Tests (Production Target)"
    runs-on: ubuntu-latest
    environment: aws-env-amirbo-6778
    needs: [setup, deploy-prod]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-test-prod
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests on Production target
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli test \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod
        
        echo "✅ Tests completed on Production target"

  monitor-pipeline-prod-target:
    name: "Step 9 - Monitor Pipeline Status (Production Target)"
    runs-on: ubuntu-latest
    environment: aws-env-amirbo-6778
    needs: [setup, run-tests-prod-target]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-monitor-prod
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Monitor pipeline status for Production target
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli monitor \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod \
          --output TEXT
        
        echo "✅ Pipeline monitoring completed for Production target"

  execute-workflows-prod-target:
    name: "Step 10 - Execute Workflow Commands (Production Target)"
    runs-on: ubuntu-latest
    environment: aws-env-amirbo-6778
    needs: [setup, monitor-pipeline-prod-target]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
        role-session-name: smus-pipeline-lifecycle-execute-prod
        role-duration-seconds: 43200  # 12 hours for long-running operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd experimental/SMUS-CICD-pipeline-cli
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Trigger DAG on Production target
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod --workflow test_dag \
          --command "dags trigger test_dag"
        
        echo "✅ DAG triggered on Production target"
    
    - name: List DAG tasks on Production target
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod --workflow test_dag \
          --command "tasks list test_dag"
        
        echo "✅ DAG tasks listed on Production target"
    
    - name: Check task state on Production target
      env:
        PROD_DOMAIN_REGION: ${{ vars.PROD_DOMAIN_REGION }}
        SMUS_LOG_LEVEL: WARNING
      run: |
        cd experimental/SMUS-CICD-pipeline-cli/examples
        EXECUTION_DATE=$(date -u +'manual__%Y-%m-%dT%H:%M:%S+00:00')
        smus-cli run \
          --pipeline "${{ needs.setup.outputs.pipeline-file }}" \
          --targets prod --workflow test_dag \
          --command "tasks state test_dag hello_world $EXECUTION_DATE"
        
        echo "✅ Task state checked on Production target"
        echo "🎉 Pipeline lifecycle demo completed successfully!"
        echo "📋 Resources left in place for inspection:"
        echo "  - Test Project: dev-marketing-test"
        echo "  - Production Project: prod-marketing"
        echo "  - Domain: cicd-test-domain"
        echo "  - MWAA Environments: (if created)"
